service: serverless-color-tracking

frameworkVersion: "3"

# TODO: build Admin dashboard displaying stats per API Key (real time)

provider:
  name: aws
  runtime: python3.9
  profile: default
  region: us-east-1
  logRetentionInDays: 7
  environment:
    CONNECTIONS_TABLE: ${self:service}-${sls:stage}-connectionsTable
    STATS_TABLE: ${self:service}-${sls:stage}-statsTable
    CLICKS_STREAM: ${self:service}-${sls:stage}-clicksStream
    HOVERS_STREAM: ${self:service}-${sls:stage}-hoversStream
  websocketsApiName: ${self:service}-${sls:stage}-websocketApi
  websocketsApiRouteSelectionExpression: $request.body.action
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - kinesis:GetRecords
            - kinesis:GetShardIterator
            - kinesis:DescribeStream
            - kinesis:ListStreams
            - kinesis:PutRecord
            - kinesis:PutRecords
          Resource:
            - Fn::GetAtt: [kinesisClicksStream, Arn]
        - Effect: Allow
          Action:
            - kinesis:GetRecords
            - kinesis:GetShardIterator
            - kinesis:DescribeStream
            - kinesis:ListStreams
            - kinesis:PutRecord
            - kinesis:PutRecords
          Resource:
            - Fn::GetAtt: [kinesisHoversStream, Arn]
        - Effect: Allow
          Action:
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:Scan
          Resource: "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.STATS_TABLE}"
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:DeleteItem
            - dynamodb:Scan
          Resource: "arn:aws:dynamodb:${aws:region}:*:table/${self:provider.environment.CONNECTIONS_TABLE}"
        - Effect: Allow
          Action:
            - "execute-api:ManageConnections"
          Resource:
            - "arn:aws:execute-api:*:*:**/@connections/*"

plugins:
  - serverless-python-requirements

functions:
  createEvent:
    handler: lambdas/endpoints/v1/events/producer.handler
    events:
      - http:
          path: /v1/events
          method: post
          cors: true

  clicksConsumer:
    handler: lambdas/consumers/clicks.handler
    events:
      - stream:
          type: kinesis
          arn:
            Fn::GetAtt:
              - kinesisClicksStream
              - Arn

  hoversConsumer:
    handler: lambdas/consumers/hovers.handler
    events:
      - stream:
          type: kinesis
          arn:
            Fn::GetAtt:
              - kinesisHoversStream
              - Arn

  broadcastClicks:
    handler: lambdas/websockets/broadcast/clicks.handler
    events:
      - stream:
          type: kinesis
          arn:
            Fn::GetAtt:
              - kinesisClicksStream
              - Arn

  broadcastHovers:
    handler: lambdas/websockets/broadcast/hovers.handler
    events:
      - stream:
          type: kinesis
          arn:
            Fn::GetAtt:
              - kinesisHoversStream
              - Arn

  getStats:
    handler: lambdas/endpoints/v1/stats/get.handler
    events:
      - http:
          path: /v1/stats
          method: get
          cors: true

  websocketConnections:
    handler: lambdas/websockets/manager.handler
    events:
      - websocket:
          route: $connect
      - websocket:
          route: $disconnect

resources:
  Resources:
    kinesisClicksStream:
      Type: AWS::Kinesis::Stream
      Properties:
        Name: ${self:provider.environment.CLICKS_STREAM}
        RetentionPeriodHours: 24
        ShardCount: 1
    kinesisHoversStream:
      Type: AWS::Kinesis::Stream
      Properties:
        Name: ${self:provider.environment.HOVERS_STREAM}
        RetentionPeriodHours: 24
        ShardCount: 1
    ConnectionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.CONNECTIONS_TABLE}
        KeySchema:
          - AttributeName: ConnectionId
            KeyType: HASH
        AttributeDefinitions:
          - AttributeName: ConnectionId
            AttributeType: S
        BillingMode: PAY_PER_REQUEST
    StatsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.STATS_TABLE}
        KeySchema:
          - AttributeName: Id
            KeyType: HASH
        AttributeDefinitions:
          - AttributeName: Id
            AttributeType: S
        BillingMode: PAY_PER_REQUEST
